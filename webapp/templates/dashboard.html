<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition Attendance System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .header-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin-right: 20px;
        }

        .header-title h1 {
            font-size: 32px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .nav-tab {
            padding: 12px 30px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #2c3e50;
            color: white;
        }

        .nav-tab:hover {
            background: #ecf0f1;
        }

        .nav-tab.active:hover {
            background: #2c3e50;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Date Display */
        .date-display {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .date-display span {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            color: #34495e;
            font-weight: 500;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .stat-card.red {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .stat-content h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-content .stat-number {
            font-size: 48px;
            font-weight: 700;
        }

        .stat-icon {
            font-size: 50px;
            opacity: 0.3;
        }

        /* Camera Control Section */
        .camera-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .camera-section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
        }

        .camera-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .btn-start {
            background: #11998e;
            color: white;
        }

        .btn-start:hover {
            background: #0d7d72;
            transform: translateY(-2px);
        }

        .btn-stop {
            background: #eb3349;
            color: white;
        }

        .btn-stop:hover {
            background: #c42838;
            transform: translateY(-2px);
        }

        .btn-refresh {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .btn-refresh:hover {
            background: #d5dbdb;
            transform: translateY(-2px);
        }

        /* Attendance Table Section */
        .attendance-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .attendance-section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        thead th {
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #ecf0f1;
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody td {
            padding: 15px;
            color: #2c3e50;
            font-size: 15px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.present {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.half-day {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.absent {
            background: #f8d7da;
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Reports & Analytics Tab */
        .alert-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-icon {
            font-size: 30px;
        }

        .alert-content h3 {
            font-size: 16px;
            color: #856404;
            margin-bottom: 5px;
        }

        .alert-content p {
            color: #856404;
            font-size: 14px;
        }

        .alert-content a {
            color: #856404;
            font-weight: 600;
            text-decoration: underline;
        }

        .report-controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .report-controls label {
            font-weight: 600;
            color: #2c3e50;
        }

        .report-controls select {
            padding: 10px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 15px;
            color: #2c3e50;
            cursor: pointer;
            min-width: 250px;
        }

        .report-controls input {
            padding: 10px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 15px;
            color: #2c3e50;
            min-width: 200px;
        }

        .btn-export {
            background: #3498db;
            color: white;
        }
        
        .btn-export:hover {
            background: #2980b9;
        }

        .btn-apply {
            background: #27ae60;
            color: white;
        }

        .btn-apply:hover {
            background: #219653;
        }

        .btn-view-defaulters {
            background: #e74c3c;
            color: white;
        }

        .btn-view-defaulters:hover {
            background: #c0392b;
        }

        .defaulters-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .defaulters-section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #e74c3c;
        }

        .action-btn {
            background: transparent;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #ecf0f1;
        }

        .date-range-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .date-range-controls .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .date-range-controls .date-input-group label {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }

        .student-report-preview {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .student-report-preview h2 {
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header-title h1 {
                font-size: 24px;
            }

            .camera-controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .report-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .report-controls select,
            .report-controls input {
                width: 100%;
            }

            .date-range-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-icon">üéì</div>
            <div class="header-title">
                <h1>Face Recognition Attendance System</h1>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="switchTab('reports')">Reports & Analytics</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- Date Display -->
            <div class="date-display">
                <span>üìÖ {{ today }}</span>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-content">
                        <h3>Total Students</h3>
                        <div class="stat-number">{{ total_students }}</div>
                    </div>
                    <div class="stat-icon">üë•</div>
                </div>

                <div class="stat-card green">
                    <div class="stat-content">
                        <h3>Present Today</h3>
                        <div class="stat-number">{{ present_count }}</div>
                    </div>
                    <div class="stat-icon">‚úì</div>
                </div>

                <div class="stat-card red">
                    <div class="stat-content">
                        <h3>Absent Today</h3>
                        <div class="stat-number">{{ absent_count }}</div>
                    </div>
                    <div class="stat-icon">‚úó</div>
                </div>
            </div>

            <!-- Camera Control -->
            <div class="camera-section">
                <h2>üì∑ Camera Control</h2>
                <div class="camera-controls">
                    <button class="btn btn-start" onclick="startCamera()">
                        ‚ñ∂ Start Camera
                    </button>
                    <button class="btn btn-stop" onclick="stopCamera()">
                        ‚èπ Stop Camera
                    </button>
                    <button class="btn btn-refresh" onclick="refreshData()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>

            <!-- Today's Attendance Table -->
            <div class="attendance-section">
                <h2>üìã Today's Attendance</h2>
                <div class="table-wrapper">
                    {% if attendance_records %}
                    <table>
                        <thead>
                            <tr>
                                <th>S.NO</th>
                                <th>ID</th>
                                <th>NAME</th>
                                <th>IN TIME</th>
                                <th>OUT TIME</th>
                                <th>STATUS</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in attendance_records %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ record.id }}</td>
                                <td>{{ record.name }}</td>
                                <td>{{ record.intime }}</td>
                                <td>{{ record.outtime }}</td>
                                <td>
                                    {% if record.status == 'PRESENT' %}
                                    <span class="status-badge present">Present</span>
                                    {% elif record.status == 'HALF DAY' %}
                                    <span class="status-badge half-day">Half Day</span>
                                    {% else %}
                                    <span class="status-badge absent">Absent</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>No attendance records for today yet. Start the camera to begin taking attendance.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Attendance History Section -->
            <div class="attendance-section">
                <h2>üìä Attendance History</h2>
                <div class="report-controls">
                    <label for="historyDateSelect">Select Date:</label>
                    <select id="historyDateSelect" onchange="loadAttendanceByDate()">
                        <option value="">-- Select a date --</option>
                    </select>
                    <button class="btn btn-export" onclick="exportAttendanceByDate()">
                        üì• Export to Excel
                    </button>
                </div>
                <div class="table-wrapper">
                    <table id="historyAttendanceTable">
                        <thead>
                            <tr>
                                <th>S.NO</th>
                                <th>ID</th>
                                <th>NAME</th>
                                <th>IN TIME</th>
                                <th>OUT TIME</th>
                                <th>STATUS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    Select a date to view attendance history
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports & Analytics Tab -->
        <div id="reports" class="tab-content">
            <!-- Defaulters Alert -->
            <div class="alert-box">
                <div class="alert-icon">‚ö†Ô∏è</div>
                <div class="alert-content">
                    <h3>Attendance Defaulters Alert</h3>
                    <p id="defaulters-alert">Loading defaulters information...</p>
                </div>
            </div>

            <!-- Report Controls -->
            <div class="report-controls">
                <div style="display: flex; flex-direction: column; gap: 15px; width: 100%;">
                    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <label>Select Student:</label>
                        <select id="studentSelect">
                            <option value="">-- Select a student --</option>
                            {% for student in students_list %}
                            <option value="{{ student.id }}">{{ student.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="date-range-controls">
                        <div class="date-input-group">
                            <label for="startDate">Start Date:</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="date-input-group">
                            <label for="endDate">End Date:</label>
                            <input type="date" id="endDate">
                        </div>
                        <button class="btn btn-apply" onclick="applyDateFilter()" style="margin-top: 25px;">
                            ‚úÖ Apply Filter
                        </button>
                        <button class="btn btn-export" onclick="exportStudentReport()" style="margin-top: 25px;">
                            üì• Export to Excel
                        </button>
                        <button class="btn btn-view-defaulters" onclick="scrollToDefaulters()" style="margin-top: 25px;">
                            ‚ö†Ô∏è View Defaulters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Student Report Preview Section -->
            <div class="student-report-preview" id="studentReportPreview" style="display: none;">
                <h2>üìä Student Report Preview</h2>
                <div id="reportSummary" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <!-- Summary will be loaded here -->
                </div>
                <div class="table-wrapper">
                    <table id="studentReportTable">
                        <thead>
                            <tr>
                                <th>S.NO</th>
                                <th>DATE</th>
                                <th>IN TIME</th>
                                <th>OUT TIME</th>
                                <th>STATUS</th>
                                <th>LATE?</th>
                                <th>EARLY?</th>
                            </tr>
                        </thead>
                        <tbody id="studentReportTbody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    Apply date filter to preview student report
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Defaulters Table -->
            <div class="defaulters-section" id="defaulters-section">
                <h2>‚ö†Ô∏è Students Below 75% Attendance</h2>
                <div class="table-wrapper">
                    <table id="defaulters-table">
                        <thead>
                            <tr>
                                <th>S.NO</th>
                                <th>ID</th>
                                <th>NAME</th>
                                <th>ATTENDANCE %</th>
                                <th>PRESENT</th>
                                <th>ABSENT</th>
                                <th>ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="defaulters-tbody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    Loading attendance data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab Switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
            
            // Load defaulters when reports tab is opened
            if (tabName === 'reports') {
                loadDefaulters();
                setDefaultDates();
            }
            
            // Load available dates when dashboard tab is opened
            if (tabName === 'dashboard') {
                loadAvailableDates();
            }
        }

        // Set default date range (last 30 days)
        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        // Apply date filter and preview student report
        function applyDateFilter() {
            const studentId = document.getElementById('studentSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!studentId) {
                alert('Please select a student first');
                return;
            }
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (startDate > endDate) {
                alert('Start date cannot be after end date');
                return;
            }
            
            // Show loading state
            document.getElementById('studentReportTbody').innerHTML = 
                '<tr><td colspan="7" style="text-align: center; padding: 40px;">Loading student report...</td></tr>';
            document.getElementById('studentReportPreview').style.display = 'block';
            
            // Fetch student report with date range
            fetch(`/api/individual_report/${studentId}?start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('studentReportTbody').innerHTML = 
                            `<tr><td colspan="7" style="text-align: center; padding: 40px; color: #e74c3c;">Error: ${data.error}</td></tr>`;
                        return;
                    }
                    
                    // Update summary
                    const summaryHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div><strong>Student:</strong> ${data.student_name} (ID: ${data.student_id})</div>
                            <div><strong>Date Range:</strong> ${startDate} to ${endDate}</div>
                            <div><strong>Total Days:</strong> ${data.total_days}</div>
                            <div><strong>Present:</strong> ${data.present_days}</div>
                            <div><strong>Half Days:</strong> ${data.half_days}</div>
                            <div><strong>Absent:</strong> ${data.absent_days}</div>
                            <div><strong>Attendance %:</strong> ${data.attendance_percentage}%</div>
                            <div><strong>Status:</strong> <span class="status-badge ${data.is_defaulter ? 'absent' : 'present'}">${data.is_defaulter ? 'DEFAULTER' : 'GOOD STANDING'}</span></div>
                        </div>
                    `;
                    document.getElementById('reportSummary').innerHTML = summaryHTML;
                    
                    // Update table
                    if (data.attendance_history && data.attendance_history.length > 0) {
                        let tableHTML = '';
                        data.attendance_history.forEach((record, index) => {
                            const statusClass = 
                                record.status === 'PRESENT' ? 'present' :
                                record.status === 'HALF DAY' ? 'half-day' : 'absent';
                            
                            tableHTML += `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${record.date}</td>
                                    <td>${record.in_time}</td>
                                    <td>${record.out_time}</td>
                                    <td>
                                        <span class="status-badge ${statusClass}">${record.status}</span>
                                    </td>
                                    <td>${record.is_late ? 'YES' : 'NO'}</td>
                                    <td>${record.is_early ? 'YES' : 'NO'}</td>
                                </tr>
                            `;
                        });
                        document.getElementById('studentReportTbody').innerHTML = tableHTML;
                    } else {
                        document.getElementById('studentReportTbody').innerHTML = 
                            '<tr><td colspan="7" style="text-align: center; padding: 40px;">No attendance records found for the selected date range</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading student report:', error);
                    document.getElementById('studentReportTbody').innerHTML = 
                        '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #e74c3c;">Error loading student report</td></tr>';
                });
        }

        // Load available dates for history section
        function loadAvailableDates() {
            fetch('/api/attendance_dates')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('historyDateSelect');
                    select.innerHTML = '<option value="">-- Select a date --</option>';
                    
                    data.dates.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = date;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading dates:', error));
        }

        // Load attendance by selected date
        function loadAttendanceByDate() {
            const date = document.getElementById('historyDateSelect').value;
            if (!date) {
                document.getElementById('historyAttendanceTable').innerHTML = 
                    '<thead><tr><th>S.NO</th><th>ID</th><th>NAME</th><th>IN TIME</th><th>OUT TIME</th><th>STATUS</th></tr></thead><tbody><tr><td colspan="6" style="text-align: center; padding: 40px;">Select a date to view attendance history</td></tr></tbody>';
                return;
            }

            fetch(`/api/attendance_by_date?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    const table = document.getElementById('historyAttendanceTable');
                    
                    if (data.attendance && data.attendance.length > 0) {
                        let tableHTML = `
                            <thead>
                                <tr>
                                    <th>S.NO</th>
                                    <th>ID</th>
                                    <th>NAME</th>
                                    <th>IN TIME</th>
                                    <th>OUT TIME</th>
                                    <th>STATUS</th>
                                </tr>
                            </thead>
                            <tbody>
                        `;
                        
                        data.attendance.forEach((record, index) => {
                            const statusClass = 
                                record.status === 'PRESENT' ? 'present' :
                                record.status === 'HALF DAY' ? 'half-day' : 'absent';
                            
                            tableHTML += `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${record.id}</td>
                                    <td>${record.name}</td>
                                    <td>${record.intime}</td>
                                    <td>${record.outtime}</td>
                                    <td>
                                        <span class="status-badge ${statusClass}">${record.status}</span>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += '</tbody>';
                        table.innerHTML = tableHTML;
                    } else {
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>S.NO</th>
                                    <th>ID</th>
                                    <th>NAME</th>
                                    <th>IN TIME</th>
                                    <th>OUT TIME</th>
                                    <th>STATUS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px;">
                                        No attendance records for this date
                                    </td>
                                </tr>
                            </tbody>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading attendance:', error);
                    document.getElementById('historyAttendanceTable').innerHTML = 
                        '<thead><tr><th>S.NO</th><th>ID</th><th>NAME</th><th>IN TIME</th><th>OUT TIME</th><th>STATUS</th></tr></thead><tbody><tr><td colspan="6" style="text-align: center; padding: 40px; color: #e74c3c;">Error loading attendance data</td></tr></tbody>';
                });
        }

        // Export attendance by selected date
        function exportAttendanceByDate() {
            const date = document.getElementById('historyDateSelect').value;
            if (!date) {
                alert('Please select a date first!');
                return;
            }

            window.location.href = `/api/export_attendance?date=${date}`;
        }

        // Camera Controls
        function startCamera() {
            fetch('/api/start_camera')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Camera started successfully!');
                    } else {
                        alert('Failed to start camera');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error starting camera');
                });
        }

        function stopCamera() {
            fetch('/api/stop_camera')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Camera stopped successfully!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function refreshData() {
            location.reload();
        }

        // Load Defaulters
        function loadDefaulters() {
            fetch('/api/students_analytics')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('defaulters-tbody');
                    const alertText = document.getElementById('defaulters-alert');
                    
                    if (data.defaulters && data.defaulters.length > 0) {
                        alertText.innerHTML = `${data.defaulters.length} student(s) have attendance below 75%. <a href="#defaulters-section">View Defaulters</a> to see details.`;
                        
                        tbody.innerHTML = '';
                        data.defaulters.forEach((student, index) => {
                            const row = `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${student.id}</td>
                                    <td>${student.name}</td>
                                    <td>
                                        <span class="status-badge ${student.attendance_percentage < 50 ? 'absent' : 'half-day'}">
                                            ${student.attendance_percentage}%
                                        </span>
                                    </td>
                                    <td>${student.present_days}</td>
                                    <td>${student.absent_days}</td>
                                    <td>
                                        <button class="action-btn" onclick="viewStudentDetails('${student.id}')">
                                            üëÅÔ∏è View Details
                                        </button>
                                    </td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });
                    } else {
                        alertText.textContent = 'Great! All students have attendance above 75%.';
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #27ae60;">‚úì No defaulters found. All students have good attendance!</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading defaulters:', error);
                    document.getElementById('defaulters-tbody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #e74c3c;">Error loading data</td></tr>';
                });
        }

        function scrollToDefaulters() {
            document.getElementById('defaulters-section').scrollIntoView({ behavior: 'smooth' });
        }

        function exportStudentReport() {
            const studentId = document.getElementById('studentSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!studentId) {
                alert('Please select a student first');
                return;
            }
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (startDate > endDate) {
                alert('Start date cannot be after end date');
                return;
            }
            
            window.location.href = `/api/export_student_report/${studentId}?start_date=${startDate}&end_date=${endDate}`;
        }

        function viewStudentDetails(studentId) {
            window.location.href = `/api/individual_report/${studentId}`;
        }

        // Auto-refresh attendance every 30 seconds when on dashboard
        setInterval(() => {
            if (document.getElementById('dashboard').classList.contains('active')) {
                fetch('/api/todays_attendance')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Attendance updated:', data);
                        // You can update the table here without full page refresh if needed
                    });
            }
        }, 30000);

        // Load available dates on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadAvailableDates();
        });
    </script>
</body>
</html>