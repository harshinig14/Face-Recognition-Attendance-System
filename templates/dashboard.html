<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition Attendance System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .header-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin-right: 20px;
        }

        .header-title h1 {
            font-size: 32px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .nav-tab {
            padding: 12px 30px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #2c3e50;
            color: white;
        }

        .nav-tab:hover {
            background: #ecf0f1;
        }

        .nav-tab.active:hover {
            background: #2c3e50;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Date Display */
        .date-display {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .date-display span {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            color: #34495e;
            font-weight: 500;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .stat-card.red {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .stat-content h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-content .stat-number {
            font-size: 48px;
            font-weight: 700;
        }

        .stat-icon {
            font-size: 50px;
            opacity: 0.3;
        }

        /* Camera Control Section */
        .camera-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .camera-section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
        }

        .camera-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .btn-start {
            background: #11998e;
            color: white;
        }

        .btn-start:hover {
            background: #0d7d72;
            transform: translateY(-2px);
        }

        .btn-stop {
            background: #eb3349;
            color: white;
        }

        .btn-stop:hover {
            background: #c42838;
            transform: translateY(-2px);
        }

        .btn-refresh {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .btn-refresh:hover {
            background: #d5dbdb;
            transform: translateY(-2px);
        }

        /* Attendance Table Section */
        .attendance-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .attendance-section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        thead th {
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #ecf0f1;
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody td {
            padding: 15px;
            color: #2c3e50;
            font-size: 15px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.present {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.half-day {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.absent {
            background: #f8d7da;
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Reports & Analytics Tab */
        .alert-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-icon {
            font-size: 30px;
        }

        .alert-content h3 {
            font-size: 16px;
            color: #856404;
            margin-bottom: 5px;
        }

        .alert-content p {
            color: #856404;
            font-size: 14px;
        }

        .alert-content a {
            color: #856404;
            font-weight: 600;
            text-decoration: underline;
        }

        .report-controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .report-controls label {
            font-weight: 600;
            color: #2c3e50;
        }

        .report-controls select {
            padding: 10px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 15px;
            color: #2c3e50;
            cursor: pointer;
            min-width: 250px;
        }

        .report-controls input {
            padding: 10px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 15px;
            color: #2c3e50;
            min-width: 200px;
        }

        .btn-export {
            background: #3498db;
            color: white;
        }
        
        .btn-export:hover {
            background: #2980b9;
        }

        .btn-apply {
            background: #27ae60;
            color: white;
        }
        /* Registration Section Styles */
.registration-section {
    background: white;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.registration-subtitle {
    color: #7f8c8d;
    margin-bottom: 30px;
    font-size: 16px;
}

.registration-form {
    max-width: 500px;
    margin-bottom: 40px;
}

.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2c3e50;
    font-size: 14px;
}

.form-input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #ecf0f1;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s ease;
}

.form-input:focus {
    outline: none;
    border-color: #3498db;
}

.form-actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.btn-register {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
}

.btn-register:hover {
    background: linear-gradient(135deg, #0d7d72 0%, #2fd46b 100%);
}

.btn-train {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-train:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

.registration-instructions {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 10px;
    border-left: 4px solid #3498db;
}

.registration-instructions h3 {
    margin-bottom: 15px;
    color: #2c3e50;
}

.registration-instructions ol {
    padding-left: 20px;
}

.registration-instructions li {
    margin-bottom: 8px;
    color: #5a6c7d;
}

.result-message {
    margin-top: 20px;
    padding: 15px;
    border-radius: 8px;
    display: none;
}

.result-message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    display: block;
}

.result-message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    display: block;
}
        .btn-apply:hover {
            background: #219653;
        }

        .btn-view-defaulters {
            background: #e74c3c;
            color: white;
        }

        .btn-view-defaulters:hover {
            background: #c0392b;
        }

        .defaulters-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        }

        .defaulters-section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #e74c3c;
        }

        .action-btn {
            background: transparent;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #ecf0f1;
        }

        .date-range-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .date-range-controls .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .date-range-controls .date-input-group label {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }

        .student-report-preview {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .student-report-preview h2 {
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
        }


        .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
}
.top-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}
.logout-btn {
    padding: 8px 14px;
    border-radius: 999px;
    border: 1px solid rgba(239,68,68,0.6);
    background: rgba(127,29,29,0.9);
    color: #fee2e2;
    font-size: 12px;
    font-weight: 500;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: background 0.15s ease, transform 0.1s ease;
}
.logout-btn:hover {
    background: rgba(185,28,28,0.95);
    transform: translateY(-1px);
}


        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header-title h1 {
                font-size: 24px;
            }

            .camera-controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .report-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .report-controls select,
            .report-controls input {
                width: 100%;
            }

            .date-range-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-icon">üéì</div>
            <div class="header-title">
                <h1>Face Recognition Attendance System</h1>
            </div>

            
        </div>
         <div class="top-bar">
    <div class="app-title"></div>
    <div class="top-actions">
        <span id="admin-email-label"></span>
        <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
    </div>
</div>
       

        <!-- Navigation Tabs -->
       <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('dashboard')">Dashboard</button>
    <button class="nav-tab" onclick="switchTab('reports')">Reports & Analytics</button>
    <button class="nav-tab" onclick="switchTab('register')">Register</button>
</div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- Date Display -->
            <div class="date-display">
    <span>üìÖ <span id="today-date">Loading...</span></span>
</div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-content">
                        <h3>Total Students</h3>
                        <div class="stat-number">{{ total_students }}</div>
                    </div>
                    <div class="stat-icon">üë•</div>
                </div>

                <div class="stat-card green">
                    <div class="stat-content">
                        <h3>Present Today</h3>
                        <div class="stat-number">{{ present_count }}</div>
                    </div>
                    <div class="stat-icon">‚úì</div>
                </div>

                <div class="stat-card red">
                    <div class="stat-content">
                        <h3>Absent Today</h3>
                        <div class="stat-number">{{ absent_count }}</div>
                    </div>
                    <div class="stat-icon">‚úó</div>
                </div>
            </div>

            <!-- Camera Control -->
            <div class="camera-section">
                <h2>üì∑ Camera Control</h2>
                <div class="camera-controls">
                    <button class="btn btn-start" onclick="startCamera()">
                        ‚ñ∂ Start Camera
                    </button>
                    <button class="btn btn-stop" onclick="stopCamera()">
                        ‚èπ Stop Camera
                    </button>
                    <button class="btn btn-refresh" onclick="refreshData()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>

           

            <!-- Attendance History Section -->
            <div class="attendance-section">
                <h2>üìä Attendance</h2>
                <div class="report-controls">
                    <label for="historyDateSelect">Select Date:</label>
                    <select id="historyDateSelect" onchange="loadAttendanceByDate()">
                        <option value="">-- Select a date --</option>
                    </select>
                    <button class="btn btn-export" onclick="exportAttendanceByDate()">
                        üì• Export to Excel
                    </button>
                </div>
                <div class="table-wrapper">
                    <table id="historyAttendanceTable">
                        <thead>
                            <tr>
                                <th>S.NO</th>
                                <th>ID</th>
                                <th>NAME</th>
                                <th>IN TIME</th>
                                <th>OUT TIME</th>
                                <th>STATUS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    Select a date to view attendance history
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports & Analytics Tab -->
        <div id="reports" class="tab-content">
            <!-- Defaulters Alert -->
            <div class="alert-box">
                <div class="alert-icon">‚ö†</div>
                <div class="alert-content">
                    <h3>Attendance Defaulters Alert</h3>
                    <p id="defaulters-alert">Loading defaulters information...</p>
                </div>
            </div>

            <!-- Report Controls -->
            <div class="report-controls">
                <div style="display: flex; flex-direction: column; gap: 15px; width: 100%;">
                    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <label>Select Student:</label>
                        <select id="studentSelect">
                            <option value="">-- Select a student --</option>
                            {% for student in students_list %}
                            <option value="{{ student.id }}">{{ student.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="date-range-controls">
                        <div class="date-input-group">
                            <label for="startDate">Start Date:</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="date-input-group">
                            <label for="endDate">End Date:</label>
                            <input type="date" id="endDate">
                        </div>
                        <button class="btn btn-apply" onclick="applyDateFilter()" style="margin-top: 25px;">
                            ‚úÖ Apply Filter
                        </button>
                        <button class="btn btn-export" onclick="exportStudentReport()" style="margin-top: 25px;">
                            üì• Export to Excel
                        </button>
                    
                    </div>
                </div>
            </div>

            <!-- Student Report Preview Section -->
            <div class="student-report-preview" id="studentReportPreview" style="display: none;">
                <h2>üìä Student Report Preview</h2>
                <div id="reportSummary" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <!-- Summary will be loaded here -->
                </div>
                
                
                <div class="table-wrapper">
                    <table id="studentReportTable">
                        <thead>
                            <tr>
                                <th>S.NO</th>
                                <th>DATE</th>
                                <th>IN TIME</th>
                                <th>OUT TIME</th>
                                <th>STATUS</th>
                                <th>LATE?</th>
                                <th>EARLY?</th>
                            </tr>
                        </thead>
                        <tbody id="studentReportTbody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    Apply date filter to preview student report
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Defaulters Table -->
            <div class="defaulters-section" id="defaulters-section">
                <h2>‚ö† Students Below 75% Attendance</h2>
                <div class="table-wrapper">
                    <table id="defaulters-table">
                        <thead>
                            <tr>
                                <th>S.NO</th>
                                <th>ID</th>
                                <th>NAME</th>
                                <th>ATTENDANCE %</th>
                                <th>PRESENT</th>
                                <th>ABSENT</th>
                                <th>ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="defaulters-tbody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    Loading attendance data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Add this new Register tab content -->
<div id="register" class="tab-content">
    <!-- Registration Form -->
    <div class="registration-section">
        <h2>üéØ Student Registration</h2>
        <p class="registration-subtitle">Register new students for face recognition attendance</p>
        
        <div class="registration-form">
            <div class="form-group">
                <label for="studentName">Student Name</label>
                <input type="text" id="studentName" placeholder="Enter full name" class="form-input">
            </div>
            
            <div class="form-group">
                <label for="rollNumber">Roll Number</label>
                <input type="text" id="rollNumber" placeholder="Enter roll number" class="form-input">
            </div>
            
            <div class="form-actions">
                <button class="btn btn-register" onclick="registerStudent()">
                    üì∑ Register & Capture Photos
                </button>
                <button class="btn btn-train" onclick="trainModel()">
                    ü§ñ Train Model
                </button>
            </div>
        </div>
        
        <div class="registration-instructions">
            <h3>üìã Registration Instructions:</h3>
            <ol>
                <li>Enter student name and roll number</li>
                <li>Click "Register" to activate camera for face capture</li>
                <li>Ensure proper lighting and face positioning</li>
                <li>Camera will automatically capture 5 photos</li>
                <li>Click "Train" to update the face recognition model</li>
            </ol>
        </div>
        
        <div id="registrationResult" class="result-message"></div>
    </div>
</div>
    </div>

    <script>
// ================== TAB SWITCHING ==================
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });

    // Remove active class from all nav tabs
    document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabName).classList.add('active');

    // Add active class to clicked nav tab
    event.target.classList.add('active');

    // Load defaulters when reports tab is opened (will be implemented later)
   // In switchTab(), add after the if tabName === 'reports' check:
if (tabName === 'reports') {
    loadDefaulters();
    loadStudentDropdown();
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
}

if (tabName === 'dashboard') {
    loadAvailableDates();
}


    // Clear registration result when switching to register tab
    if (tabName === 'register') {
        const resDiv = document.getElementById('registrationResult');
        resDiv.style.display = 'none';
        resDiv.className = 'result-message';
        resDiv.innerHTML = '';
    }
}

// ================== SIMPLE HELPERS ==================
function safeJson(response) {
    const contentType = response.headers.get('content-type') || '';
    if (!contentType.includes('application/json')) {
        // Return a fake error object instead of throwing
        return Promise.resolve({ error: true, message: 'Invalid JSON response' });
    }
    return response.json();
}

// ================== REGISTRATION FUNCTIONS ==================
function registerStudent() {
    const studentName = document.getElementById('studentName').value.trim();
    const rollNumber  = document.getElementById('rollNumber').value.trim();
    const resultDiv   = document.getElementById('registrationResult');

    if (!studentName || !rollNumber) {
        resultDiv.className = 'result-message error';
        resultDiv.innerHTML = 'Please enter both student name and roll number!';
        resultDiv.style.display = 'block';
        return;
    }

    // Show loading state
    resultDiv.className = 'result-message';
    resultDiv.innerHTML = 'Starting camera... Please wait while we capture 5 photos...';
    resultDiv.style.display = 'block';

    // Disable buttons
    document.querySelector('.btn-register').disabled = true;
    document.querySelector('.btn-train').disabled    = true;

    fetch('/api/registerstudent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            studentid: rollNumber,
            studentname: studentName
        })
    })
    .then(res => safeJson(res))
    .then(data => {
        if (!data || data.error) {
            resultDiv.className = 'result-message error';
            resultDiv.innerHTML = data && data.message ? data.message : 'Unexpected server response';
            return;
        }
        if (data.success) {
            resultDiv.className = 'result-message success';
            resultDiv.innerHTML = data.message || 'Student registered and photos captured.';
            // Clear form
            document.getElementById('studentName').value = '';
            document.getElementById('rollNumber').value  = '';
        } else {
            resultDiv.className = 'result-message error';
            resultDiv.innerHTML = data.message || 'Registration failed';
        }
    })
    .catch(err => {
        console.error('Register error:', err);
        resultDiv.className = 'result-message error';
        resultDiv.innerHTML = 'Network error. Please try again.';
    })
    .finally(() => {
        document.querySelector('.btn-register').disabled = false;
        document.querySelector('.btn-train').disabled    = false;
    });
}
function loadStudentDropdown() {
    fetch('/api/studentslist')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('studentSelect');
            if (!select) return;
            select.innerHTML = '<option value="">-- Select a student --</option>';
            data.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.name} (${s.id})`;
                select.appendChild(opt);
            });
        })
        .catch(err => console.error('Error loading students:', err));
}

// Train model ‚Äì backend route not created yet, so just show placeholder
function trainModel() {
    const resultDiv = document.getElementById('registrationResult');

    resultDiv.className = 'result-message';
    resultDiv.innerHTML = 'Training face recognition model... This may take a few moments...';
    resultDiv.style.display = 'block';

    document.querySelector('.btn-register').disabled = true;
    document.querySelector('.btn-train').disabled    = true;

    fetch('/api/trainmodel', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            resultDiv.className = 'result-message success';
            resultDiv.innerHTML = data.message || 'Model trained successfully.';
        } else {
            resultDiv.className = 'result-message error';
            resultDiv.innerHTML = data.message || 'Training failed.';
        }
    })
    .catch(err => {
        console.error('Train model error:', err);
        resultDiv.className = 'result-message error';
        resultDiv.innerHTML = 'Network error during training. Please try again.';
    })
    .finally(() => {
        document.querySelector('.btn-register').disabled = false;
        document.querySelector('.btn-train').disabled    = false;
    });
}


// ================== DASHBOARD / REPORT PLACEHOLDERS ==================
// These are stub functions so your page JS does not break with 404s.
// We will implement real APIs in later phases.

function loadAvailableDates() {
    fetch('/api/attendance_dates')
        .then(res => res.json())
        .then(data => {
            if (!data.success) return;
            const select = document.getElementById('historyDateSelect');
            if (!select) return;
            select.innerHTML = '<option value="">-- Select a date --</option>';
            data.dates.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                select.appendChild(opt);
            });
        })
        .catch(err => console.error('Error loading dates:', err));
}

function loadAttendanceDates() {
    fetch('/api/attendance_dates')
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                console.error('Failed to load dates');
                return;
            }
            const sel = document.getElementById('historyDateSelect');
            if (!sel) return;

            sel.innerHTML = '<option value="">-- Select a date --</option>';

            if (!data.dates || data.dates.length === 0) {
                return; // keep only placeholder
            }

            data.dates.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                sel.appendChild(opt);
            });
        })
        .catch(err => {
            console.error('Error loading attendance dates:', err);
        });
}


function loadAttendanceByDate() {
    const date = document.getElementById('historyDateSelect').value;
    const table = document.getElementById('historyAttendanceTable');
    if (!date) {
        table.querySelector('tbody').innerHTML =
            '<tr><td colspan="6" style="text-align:center;padding:40px;">Select a date to view attendance history...</td></tr>';
        return;
    }
    fetch('/api/attendancebydate?date=' + encodeURIComponent(date))
        .then(res => res.json())
        .then(data => {
            const tbody = table.querySelector('tbody');
            if (!data.success || !data.records.length) {
                tbody.innerHTML =
                    '<tr><td colspan="6" style="text-align:center;padding:40px;">No attendance records for this date</td></tr>';
                return;
            }
            tbody.innerHTML = data.records.map(r => {
                let cls = 'absent';
                if (r.status === 'PRESENT') cls = 'present';
                else if (r.status === 'HALF DAY') cls = 'half-day';
                return `
                    <tr>
                        <td>${r.sno}</td>
                        <td>${r.id}</td>
                        <td>${r.name}</td>
                        <td>${r.intime}</td>
                        <td>${r.outtime}</td>
                        <td><span class="status-badge ${cls}">${r.status}</span></td>
                    </tr>`;
            }).join('');
        })
        .catch(err => console.error('Error loading attendance:', err));
}



function loadDefaulters() {
    fetch('/api/students_analytics')
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById('defaulters-tbody');
            const alertText = document.getElementById('defaulters-alert');
            if (!data.success) {
                alertText.textContent = 'Error loading defaulters.';
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#e74c3c;">Error loading data</td></tr>';
                return;
            }
            const defaulters = data.defaulters || [];
            if (!defaulters.length) {
                alertText.textContent = 'Great! All students have attendance above 75%.';
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#27ae60;">No defaulters found. All students have good attendance!</td></tr>';
                return;
            }
            alertText.innerHTML = `${defaulters.length} students have attendance below 75%.`;
            tbody.innerHTML = defaulters.map((s, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td><span class="status-badge ${s.attendancepercentage < 50 ? 'absent' : 'half-day'}">${s.attendancepercentage}%</span></td>
                    <td>${s.presentdays}</td>
                    <td>${s.absentdays}</td>
                    <td><button class="action-btn" onclick="viewStudentDetails('${s.id}')">View Details</button></td>
                </tr>
            `).join('');
        })
        .catch(err => console.error('Error loading defaulters:', err));
}


function applyDateFilter() {
    const studentId = document.getElementById('studentSelect').value;
    const startDate = document.getElementById('startDate').value;
    const endDate   = document.getElementById('endDate').value;
    if (!studentId) { alert('Please select a student first'); return; }
    if (!startDate || !endDate) { alert('Please select both start and end dates'); return; }
    if (startDate > endDate) { alert('Start date cannot be after end date'); return; }

    const tbody = document.getElementById('studentReportTbody');
    const preview = document.getElementById('studentReportPreview');
    const summary = document.getElementById('reportSummary');

    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;">Loading student report...</td></tr>';
    preview.style.display = 'block';

    fetch(`/api/individualreport/${studentId}?startdate=${startDate}&enddate=${endDate}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:#e74c3c;">Error: ${data.error}</td></tr>`;
                return;
            }

            const statusBadgeClass = data.isdefaulter ? 'absent' : 'present';
            const statusText = data.isdefaulter ? 'DEFAULTER' : 'GOOD STANDING';
            summary.innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                    <div><strong>Student</strong><br>${data.studentname} (ID: ${data.studentid})</div>
                    <div><strong>Date Range</strong><br>${startDate} to ${endDate}</div>
                    <div><strong>Total Days</strong><br>${data.totaldays}</div>
                    <div><strong>Present</strong><br>${data.presentdays}</div>
                    <div><strong>Half Days</strong><br>${data.halfdays}</div>
                    <div><strong>Absent</strong><br>${data.absentdays}</div>
                    <div><strong>Attendance %</strong><br>${data.attendancepercentage}%</div>
                    <div><strong>Status</strong><br><span class="status-badge ${statusBadgeClass}">${statusText}</span></div>
                </div>
            `;

            if (!data.attendancehistory || !data.attendancehistory.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;">No attendance records found for the selected date range</td></tr>';
                return;
            }

            tbody.innerHTML = data.attendancehistory.map((r, i) => {
                let cls = 'absent';
                if (r.status === 'PRESENT') cls = 'present';
                else if (r.status === 'HALF DAY') cls = 'half-day';
                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${r.date}</td>
                        <td>${r.intime}</td>
                        <td>${r.outtime}</td>
                        <td><span class="status-badge ${cls}">${r.status}</span></td>
                        <td>${r.islate ? 'YES' : 'NO'}</td>
                        <td>${r.isearly ? 'YES' : 'NO'}</td>
                    </tr>`;
            }).join('');
        })
        .catch(err => {
            console.error('Error loading student report:', err);
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#e74c3c;">Error loading student report</td></tr>';
        });
}
function exportStudentReport() {
    const studentId = document.getElementById('studentSelect').value;
    const startDate = document.getElementById('startDate').value;
    const endDate   = document.getElementById('endDate').value;

    if (!studentId) {
        alert('Please select a student first');
        return;
    }
    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }

    // Trigger file download from Flask
    window.location.href = `/api/exportstudentreport/${studentId}?startdate=${startDate}&enddate=${endDate}`;
}


function viewStudentDetails(studentId) {
    document.getElementById('studentSelect').value = studentId;
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    applyDateFilter();
    document.getElementById('studentReportPreview').scrollIntoView({ behavior: 'smooth' });
}


function exportAttendanceByDate() {
    const date = document.getElementById('historyDateSelect').value;
    if (!date) {
        alert('Please select a date first!');
        return;
    }
    window.location.href = '/api/exportattendance?date=' + encodeURIComponent(date);
}




function viewStudentDetails(studentId) {
    alert('View details for student ' + studentId + ' will be implemented later.');
}
function displayTodayDate() {
    const today = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dateStr = today.toLocaleDateString('en-IN', options);
    const dateElem = document.getElementById('today-date');
    if (dateElem) {
        dateElem.textContent = dateStr;
    }
}
function startCamera() {
    fetch('/api/takeattendance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message +
                '\nName: ' + data.name +
                '\nRoll No: ' + data.rollno +
                '\nConfidence: ' + data.confidence + '%');
            loadTodaysAttendance();  // refresh table + cards
        } else {
            alert(data.message || 'Failed to mark attendance');
        }
    })
    .catch(err => {
        console.error('Attendance error:', err);
        alert('Network error while taking attendance.');
    });
}

function stopCamera() {
    alert('Camera closes when you press ESC in the attendance window.');
}

function refreshData() {
    location.reload();
}

function loadTodaysAttendance() {
    fetch('/api/todays_attendance')
        .then(res => res.json())
        .then(data => {
            if (!data.success) return;

            // Update stat cards
            const totalEl   = document.querySelector('.stat-card.blue .stat-number');
            const presentEl = document.querySelector('.stat-card.green .stat-number');
            const absentEl  = document.querySelector('.stat-card.red .stat-number');
            if (totalEl)   totalEl.textContent   = data.total_students;
            if (presentEl) presentEl.textContent = data.present;
            if (absentEl)  absentEl.textContent  = data.absent;

            // Update today's table body
            const tbody = document.querySelector('#dashboard-today-tbody') 
                       || document.querySelector('.attendance-section tbody');
            if (!tbody) return;

            if (!data.records || !data.records.length) {
                tbody.innerHTML =
                    '<tr><td colspan="6" style="text-align:center;padding:40px;">No students registered.</td></tr>';
                return;
            }

            const rowsHtml = data.records.map(r => {
                let statusClass = 'absent';
                if (r.status === 'PRESENT') statusClass = 'present';
                else if (r.status === 'HALF DAY') statusClass = 'half-day';

                return `
                    <tr>
                        <td>${r.sno}</td>
                        <td>${r.id}</td>
                        <td>${r.name}</td>
                        <td>${r.intime}</td>
                        <td>${r.outtime}</td>
                        <td><span class="status-badge ${statusClass}">${r.status}</span></td>
                    </tr>`;
            }).join('');

            tbody.innerHTML = rowsHtml;
        })
        .catch(err => {
            console.error('Error loading today attendance:', err);
        });
}


window.addEventListener('DOMContentLoaded', function () {
    displayTodayDate();
    loadTodaysAttendance();   // auto-load on dashboard open
    loadAttendanceDates();
});




</script>

</body>
</html>